<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criador de Cart√µes Estilo RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Estilos gerais e de anima√ß√£o (sem altera√ß√µes) */
        .divPartculas h2 {
            font-size: 2em;
            margin: 0 0 10px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        .divPartculas p { font-size: 1em; }
        .sparkle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0; 
            animation: disperse var(--duration) forwards; 
        }
        @keyframes disperse {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: .3; }
            100% { transform: translate(var(--x), var(--y)) scale(0) rotate(var(--r)); opacity: 0; }
        }
        .back-content{
            width: 100%;
            height: calc(100% - 30px);
            margin: 15px;
            border-radius: 7px;
        }
        .card-3d-container { perspective: 1500px; width: 100%; height: 650px; }
        .card-3d {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d; 
            transition: transform 0.6s;
            cursor: pointer;
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; 
            border-radius: 20px;
            box-shadow: 0px 0px 6px 0px #0f1908;
        }
        .card-back {
            transform: rotateY(180deg); 
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .rpg-card .ex-max { background-size: cover; background-blend-mode: multiply; }
        .rpg-card:fullscreen .card-3d-container{ width: 90%;}
        .rpg-card:fullscreen .ex-max, .rpg-card:fullscreen .card-3d-container {
            display: flex;
            border-radius: 10px;
            justify-content: center;
            background-size: cover !important;
        }
        .rpg-card:fullscreen .img-max {
            width: 200px !important;
            height: 200px;
            position: absolute;
            left: 0;
            right: 0;
            margin: auto;
        }
        .rpg-card:fullscreen .img-max img { width: 100%; height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #111827, #1f2937);
            color: #d1d5db;
        }
        #mainContent {
             padding-bottom: 70px; /* Adiciona espa√ßo para o menu fixo */
        }
        input:focus, textarea:focus {
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.5);
            border-color: #8b5cf6;
            outline: none;
        }
        .btn-gradient-pulse {
            background-size: 200% 200%;
            animation: pulse-gradient 2s linear infinite;
        }
        @keyframes pulse-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .rpg-card {
            background-image: url('https://placehold.co/400x600/1e293b/d1d5db?text=Fundo+do+Cart√£o');
            background-size: cover;
            background-position: center;
            border: 4px solid #1f2937;
            position: relative;
        }
        .rpg-card-frame {
            backdrop-filter: blur(8px);
            border: 2px solid var(--border-color, #4b5563);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease-in-out;
            background-color: var(--card-bg-color, rgba(31, 41, 55, 0.9));
            color: var(--text-color, #f3f4f6);
            width: 100%;
        }
        .rpg-card:fullscreen {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            border: 0;
            border-radius: 0;
            background-blend-mode: multiply;
        }
        .rpg-card:fullscreen .rpg-card-frame { max-width: 100%; max-height: 90vh; overflow-y: auto; }
        .rpg-card:fullscreen button, .rpg-card:fullscreen .swiper-navigation { display: none; }
        .rpg-card-title-divider {
            height: 2px;
            width: 80%;
            background: linear-gradient(to right, transparent, var(--border-color, #6b7280), transparent);
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .file-upload-input {
            width: 100%; padding: 0.5rem 1rem; margin-top: 0.25rem; background-color: #4b5563;
            color: white; border-radius: 0.5rem; border: 1px solid #4b5563;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        .file-upload-input:hover { border-color: #6b7280; }
        .file-upload-input::-webkit-file-upload-button {
            background-color: #6366f1; color: white; padding: 0.5rem 1rem; border: none;
            border-radius: 9999px; font-weight: 600; margin-right: 1rem; cursor: pointer;
        }
        .file-upload-input::-webkit-file-upload-button:hover { background-color: #4f46e5; }
        small {
            position: absolute; left: -10px; top: -10px; padding: 5px; border-radius: 50px;
            font-size: 11px !important; width: 30px; height: 30px; display: flex;            
            align-items: center; justify-content: center; transform: scale(0.8);
        }
        #thumbnail-list, #spell-thumbnail-list, #item-thumbnail-list {
            min-height: 7rem;
            max-height: 8rem; overflow-y: hidden; overflow-x: auto; display: flex; flex-direction: row;
            flex-wrap: nowrap; justify-content: flex-start; align-items: center;
            background-color: rgb(30 41 59 / var(--tw-bg-opacity, 1));
        }
        .splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--card-bg-color, rgba(31, 41, 55, 0.9));
            color: #f3f4f6; display: flex; flex-direction: column; justify-content: center;
            align-items: center; z-index: 9999; transition: opacity 1s ease-in-out;
        }
        .splash-screen.hidden { opacity: 0; pointer-events: none; }
        #loaderClipRect { transition: height 0.5s ease-in-out; }
        .progress-text { text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .stat-fill {
            height: 100%; background-color: #eab308; border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .stat-bar {
            background-color: #4a5568; border-radius: 9999px; height: 8px;
            margin-top: 0.25rem; position: relative;
        }
        /* Estilos para o novo menu de navega√ß√£o */
        .nav-button {
            transition: all 0.3s ease-in-out;
            color: #d1d5db; /* gray-300 */
        }
        .nav-button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.5);
        }
        .nav-button:not(.active):hover {
            background-color: #374151; /* gray-700 */
        }

        /* ESTILOS ATUALIZADOS: Barra de magias retr√°til */
        .fullscreen-tab-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 20px);
            max-width: calc(100% - 20px);
            z-index: 100;
            transition: transform 0.4s ease-out;
        }
        .fullscreen-tab-container.collapsed {
            transform: translate(-50%, calc(100% - 45px));
            bottom: -45px;
        }
        .tab-list-toggler {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 20px;
            background-color: #1f2834;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-list-toggler svg {
            transition: transform 0.3s ease;
        }
        .fullscreen-tab-container.collapsed .tab-list-toggler svg {
            transform: rotate(180deg);
        }
        .fullscreen-tab-content {
            padding: 10px;
            background-color: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            gap: 15px;
            overflow-x: auto;
        }
        .fullscreen-tab-content::-webkit-scrollbar { height: 5px; }
        .fullscreen-tab-content::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
        .fullscreen-tab-content::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        .tab-list-item {
            cursor: pointer;
            text-align: center;
            transition: transform 0.2s ease;
            flex-shrink: 0;
            width: 80px;
        }
        .tab-list-item:hover { transform: scale(1.1); }
        .tab-list-item img {
            width: 60px;
            height: 60px;
            border-radius: 20px;
            border: 3px solid #4f46e5;
            object-fit: cover;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.7);
        }
        .tab-list-item p {
            margin-top: 5px;
            font-size: 12px;
            color: #d1d5db;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 80px;
        }

        /* ESTILOS ATUALIZADOS: Card de magia expandido */
        .expanded-card-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 200;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
            pointer-events: none;
        }
        .expanded-card {
            transform: scale(0.8) !important;
            transition: transform 0.1s ease-in-out;
            cursor: default;
            max-width: 90%;
            width: 450px;
            height: 650px; /* Altura fixa para consist√™ncia */
        }
        .expanded-card-container.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .expanded-card-container.visible .expanded-card {
            transform: scale(1);
        }

        /* NOVOS ESTILOS: Anima√ß√£o de entrada do card */
        .card-wrapper {
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease-out;
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }
        .card-wrapper.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        
        /* NOVOS ESTILOS: Abas expans√≠veis */
        .section-toggle-btn {
            background-color: #1f2937;
            color: #d1d5db;
            padding: 0.75rem 1.5rem;
            width: 100%;
            text-align: left;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .section-toggle-btn:hover {
            background-color: #374151;
        }
        .section-toggle-btn svg {
            transition: transform 0.3s ease;
        }
        .section-toggle-btn.active svg {
            transform: rotate(180deg);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-content.expanded {
            max-height: 1000px; /* Valor alto para garantir que o conte√∫do caiba */
        }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-2">

    <div id="splashScreen" class="splash-screen">
        <svg xmlns="http://www.w3.org/2000/svg" class="loading-icon text-indigo-400 w-20 h-20" viewBox="0 0 24 24" fill="currentColor">
            <defs><clipPath id="loaderClipPath"><rect id="loaderClipRect" x="0" y="0" width="24" height="0" /></clipPath></defs>
            <g clip-path="url(#loaderClipPath)">
                <rect x="5" y="2" width="14" height="20" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M12 7.74l1.39 2.82 3.12.45-2.26 2.2.53 3.11-2.78-1.46-2.78 1.46.53-3.11-2.26-2.2 3.12.45L12 7.74z" fill="currentColor"/>
            </g>
        </svg>
        <h1 class="text-3xl font-bold mt-4">Forjando Cart√µes...</h1>
        <p id="progressText" class="text-sm mt-2 font-medium progress-text">Preparando...</p>
        <div class="absolute inset-0"></div>
    </div>

    <div id="mainContent" class="w-full max-w-5xl hidden">

        
        <div id="creation-section" class="hidden">
            <div class="bg-slate-800 text-white p-6 rounded-3xl shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="form-title" class="text-2xl font-bold text-indigo-300">Novo Cart√£o de Personagem</h2>
                    <button class="back-btn text-gray-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <form id="cardForm" class="space-y-6">
                    <div>
                        <label for="cardTitle" class="block text-sm font-semibold mb-1">Nome</label>
                        <input type="text" id="cardTitle" placeholder="Ex: Guerreiro Lend√°rio" required class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600">
                    </div>
                    <div>
                        <label for="cardSubTitle" class="block text-sm font-semibold mb-1">Ra√ßa e Classe</label>
                        <input type="text" id="cardSubTitle" placeholder="Ex: Humano Mago" required class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600">
                    </div>
                    <div>
                        <label for="cardLevel" class="block text-sm font-semibold mb-1">N√≠vel</label>
                        <input type="number" id="cardLevel" placeholder="1" required class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600">
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-indigo-300 mb-2">Imagem do Personagem</h3>
                        <div class="mt-4 text-center">
                            <label for="characterImageUpload" class="block text-sm font-semibold mb-1 cursor-pointer">Fa√ßa upload de uma imagem:</label>
                            <input type="file" id="characterImageUpload" accept="image/*" class="file-upload-input">
                            <img id="characterImagePreview" class="mt-4 mx-auto w-32 h-32 object-cover rounded-full border-4 border-gray-600 hidden" alt="Pr√©-visualiza√ß√£o do Personagem">
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-indigo-300 mb-2">Imagem de Fundo</h3>
                        <div class="mt-4 text-center">
                            <label for="backgroundImageUpload" class="block text-sm font-semibold mb-1 cursor-pointer">Fa√ßa upload de uma imagem:</label>
                            <input type="file" id="backgroundImageUpload" accept="image/*" class="file-upload-input">
                            <div id="backgroundImagePreview" class="mt-4 mx-auto w-full h-48 rounded-lg border-4 border-gray-600 hidden bg-cover bg-center"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <h3 class="col-span-2 text-xl font-bold text-indigo-300">Atributos</h3>
                        <div><label for="vida" class="block text-sm font-semibold mb-1">Vida (PV)</label><input type="number" id="vida" placeholder="1" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                        <div><label for="mana" class="block text-sm font-semibold mb-1">Mana (PM)</label><input type="number" id="mana" placeholder="1" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                        <div><label for="agilidade" class="block text-sm font-semibold mb-1">Agilidade (AGI)</label><input type="number" id="agilidade" placeholder="1" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                        <div><label for="carisma" class="block text-sm font-semibold mb-1">Carisma (CAR)</label><input type="number" id="carisma" placeholder="1" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                        <div><label for="forca" class="block text-sm font-semibold mb-1">For√ßa (FOR)</label><input type="number" id="forca" placeholder="1" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                        <div><label for="inteligencia" class="block text-sm font-semibold mb-1">Intelig√™ncia (INT)</label><input type="number" id="inteligencia" placeholder="1" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                        <div><label for="sabedoria" class="block text-sm font-semibold mb-1">Sabedoria (SAB)</label><input type="number" id="sabedoria" placeholder="1" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                        <div><label for="vigor" class="block text-sm font-semibold mb-1">Vigor (VIG)</label><input type="number" id="vigor" placeholder="1" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-indigo-300 mb-2">Per√≠cias</h3>
                        <div id="pericias-checkboxes-container" class="space-y-2"></div>
                        <div id="pericia-description-display" class="mt-4 p-4 rounded-lg bg-gray-700 hidden">
                            <h4 id="periciaDescriptionTitle" class="font-bold text-indigo-300"></h4>
                            <p id="periciaDescriptionText" class="text-sm text-gray-300 mt-2"></p>
                        </div>
                    </div>
                    <button type="submit" id="submitButton" class="w-full py-3 px-4 rounded-full text-lg font-bold text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 focus:outline-none transition duration-300 ease-in-out transform hover:scale-105 shadow-xl btn-gradient-pulse">
                        Criar Cart√£o
                    </button>
                </form>
            </div>
        </div>
        
        <!-- SE√á√ÉO DE EXIBI√á√ÉO DE PERSONAGENS -->
        <div id="display-section">
            <div id="thumbnail-list" class="flex flex-wrap justify-center gap-4 p-4 bg-gray-900/50 rounded-xl shadow-inner mb-4">
                <p class="text-gray-500">Nenhum cart√£o salvo ainda. Crie um para come√ßar!</p>
            </div>
            <div id="card-display-area" class="w-full max-w-lg mx-auto mb-1 items-center justify-center" style="min-height: 720px;">
                <p class="text-gray-400">Selecione um personagem na lista acima para ver os detalhes.</p>
            </div>
        </div>

        <div id="spell-creation-section" class="hidden">
            <div class="bg-slate-800 text-white p-6 rounded-3xl shadow-2xl">
                 <div class="flex justify-between items-center mb-6">
                    <h2 id="spell-form-title" class="text-2xl font-bold text-teal-300">Nova Magia ou Habilidade</h2>
                    <button class="back-btn text-gray-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <form id="spellForm" class="space-y-6">
                    <div>
                        <h3 class="text-xl font-bold text-teal-300 mb-2">√çcone da Magia</h3>
                        <div class="mt-4 text-center">
                            <label for="spellImageUpload" class="block text-sm font-semibold mb-1 cursor-pointer">Fa√ßa upload de uma imagem:</label>
                            <input type="file" id="spellImageUpload" accept="image/*" class="file-upload-input">
                            <img id="spellImagePreview" class="mt-4 mx-auto w-32 h-32 object-cover rounded-full border-4 border-gray-600 hidden" alt="Pr√©-visualiza√ß√£o da Magia">
                        </div>
                    </div>
                    <div><label for="spellName" class="block text-sm font-semibold mb-1">Nome</label><input type="text" id="spellName" placeholder="Ex: Curar Ferimentos 1¬∞ C√≠rculo" required class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                    <div><label for="spellExecution" class="block text-sm font-semibold mb-1">Execu√ß√£o</label><input type="text" id="spellExecution" placeholder="Ex: padr√£o" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                    <div><label for="spellRange" class="block text-sm font-semibold mb-1">Alcance</label><input type="text" id="spellRange" placeholder="Ex: toque" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                    <div><label for="spellTarget" class="block text-sm font-semibold mb-1">Alvo</label><input type="text" id="spellTarget" placeholder="Ex: 1 ser" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                    <div><label for="spellDuration" class="block text-sm font-semibold mb-1">Dura√ß√£o</label><input type="text" id="spellDuration" placeholder="Ex: instant√¢nea" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                    <div><label for="spellDescription" class="block text-sm font-semibold mb-1">Descri√ß√£o</label><textarea id="spellDescription" rows="4" placeholder="Ex: Voc√™ canaliza energia positiva para curar..." class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></textarea></div>
                    <div><label for="spellEnhance" class="block text-sm font-semibold mb-1">Aprimorar</label><textarea id="spellEnhance" rows="3" placeholder="Ex: (+2 PM): A cura aumenta para 2d10+2..." class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></textarea></div>
                    <div><label for="spellTrue" class="block text-sm font-semibold mb-1">Verdadeiro</label><textarea id="spellTrue" rows="3" placeholder="Ex: (+9 PM): muda o alcance para 'curto'..." class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></textarea></div>
                    <button type="submit" id="spellSubmitButton" class="w-full py-3 px-4 rounded-full text-lg font-bold text-white bg-gradient-to-r from-teal-500 to-cyan-600 hover:from-teal-600 hover:to-cyan-700 focus:outline-none transition duration-300 ease-in-out transform hover:scale-105 shadow-xl">
                        Salvar Magia
                    </button>
                </form>
            </div>
        </div>

        <!-- SE√á√ÉO DE EXIBI√á√ÉO DE MAGIAS MODIFICADA -->
        <div id="spell-display-section" class="hidden">
           
                <div id="spell-thumbnail-list" class="flex flex-wrap justify-center gap-4 p-4 bg-gray-900/50 rounded-xl shadow-inner mb-4">
                    <p class="text-gray-500">Nenhuma magia salva ainda. Crie uma para come√ßar!</p>
                </div>
                <div id="spell-card-display-area" class="w-full max-w-lg mx-auto mb-1 items-center justify-center" style="min-height: 720px;">
                    <p class="text-gray-400">Selecione uma magia na lista acima para ver os detalhes.</p>
                </div>
        </div>

        <!-- NOVA SE√á√ÉO: CRIA√á√ÉO DE ITENS -->
        <div id="item-creation-section" class="hidden">
            <div class="bg-slate-800 text-white p-6 rounded-3xl shadow-2xl">
                 <div class="flex justify-between items-center mb-6">
                    <h2 id="item-form-title" class="text-2xl font-bold text-amber-300">Novo Item</h2>
                    <button class="back-btn text-gray-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <form id="itemForm" class="space-y-6">
                    <div>
                        <h3 class="text-xl font-bold text-amber-300 mb-2">√çcone do Item</h3>
                        <div class="mt-4 text-center">
                            <label for="itemImageUpload" class="block text-sm font-semibold mb-1 cursor-pointer">Fa√ßa upload de uma imagem:</label>
                            <input type="file" id="itemImageUpload" accept="image/*" class="file-upload-input">
                            <img id="itemImagePreview" class="mt-4 mx-auto w-32 h-32 object-cover rounded-full border-4 border-gray-600 hidden" alt="Pr√©-visualiza√ß√£o do Item">
                        </div>
                    </div>
                    <div><label for="itemName" class="block text-sm font-semibold mb-1">Nome</label><input type="text" id="itemName" placeholder="Ex: Po√ß√£o de Cura" required class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="itemType" class="block text-sm font-semibold mb-1">Tipo</label><input type="text" id="itemType" placeholder="Ex: Leve" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                        <div><label for="itemDamage" class="block text-sm font-semibold mb-1">Dano</label><input type="text" id="itemDamage" placeholder="Ex: 2d6" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                        <div><label for="itemCharge" class="block text-sm font-semibold mb-1">Carga</label><input type="text" id="itemCharge" placeholder="Ex: 1" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                        <div><label for="itemPrerequisite" class="block text-sm font-semibold mb-1">Pr√©-requisito</label><input type="text" id="itemPrerequisite" placeholder="Ex: Saber magia" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></div>
                    </div>
                    <div><label for="itemEffect" class="block text-sm font-semibold mb-1">Efeito</label><textarea id="itemEffect" rows="4" placeholder="Ex: Explos√£o imediata gerando fogo..." class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600"></textarea></div>
                    <button type="submit" id="itemSubmitButton" class="w-full py-3 px-4 rounded-full text-lg font-bold text-white bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 focus:outline-none transition duration-300 ease-in-out transform hover:scale-105 shadow-xl">
                        Salvar Item
                    </button>
                </form>
            </div>
        </div>

        <!-- NOVA SE√á√ÉO: EXIBI√á√ÉO DE ITENS MODIFICADA -->
        <div id="item-display-section" class="hidden">
           
                <div id="item-thumbnail-list" class="flex flex-wrap justify-center gap-4 p-4 bg-gray-900/50 rounded-xl shadow-inner mb-4">
                    <p class="text-gray-500">Nenhum item salvo ainda. Crie um para come√ßar!</p>
                </div>
                <div id="item-card-display-area" class="w-full max-w-lg mx-auto mb-1 items-center justify-center" style="min-height: 720px;">
                    <p class="text-gray-400">Selecione um item na lista acima para ver os detalhes.</p>
                </div>
        </div>


    </div>

    <!-- MENU DE NAVEGA√á√ÉO MODIFICADO -->
    <nav class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800/80 backdrop-blur-sm rounded-full p-2 flex items-center gap-2 z-50 shadow-lg" id="nav">
        <button id="showDisplayBtn" class="nav-button px-4 py-2 text-sm md:px-6 md:py-3 md:text-lg font-semibold rounded-full focus:outline-none flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1z" /></svg>
            <span class="hidden md:inline">Personagens</span>
        </button>
        <button id="showSpellDisplayBtn" class="nav-button px-4 py-2 text-sm md:px-6 md:py-3 md:text-lg font-semibold rounded-full focus:outline-none flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" /></svg>
            <span class="hidden md:inline">Grim√≥rio</span>
        </button>
        <button id="showItemDisplayBtn" class="nav-button px-4 py-2 text-sm md:px-6 md:py-3 md:text-lg font-semibold rounded-full focus:outline-none flex items-center gap-2">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4a1 1 0 00-1 1v1a1 1 0 002 0V5a1 1 0 00-1-1zm12 0a1 1 0 00-1 1v1a1 1 0 002 0V5a1 1 0 00-1-1zM5.454 8.454a1 1 0 000 1.414l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 0zm9.092 0a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /><path d="M3 10a7 7 0 1114 0v3a1 1 0 01-1 1H4a1 1 0 01-1-1v-3z" /></svg>
            <span class="hidden md:inline">Invent√°rio</span>
        </button>
        <button id="saveDbBtn" class="nav-button px-4 py-2 text-sm md:px-6 md:py-3 md:text-lg font-semibold rounded-full focus:outline-none flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            <span class="hidden md:inline">Ficha</span>
        </button>
        <button id="cleanupBtn" class="nav-button px-4 py-2 text-sm md:px-6 md:py-3 md:text-lg font-semibold rounded-full focus:outline-none flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4a1 1 0 00-1 1v1a1 1 0 002 0V5a1 1 0 00-1-1zm12 0a1 1 0 00-1 1v1a1 1 0 002 0V5a1 1 0 00-1-1zM4 9a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zm1 5a1 1 0 100 2h8a1 1 0 100-2H5z" clip-rule="evenodd" /></svg>
            <span class="hidden md:inline">Limpar</span>
        </button>
    </nav>


    <script>
        // NEW: Array to keep track of particle intervals
        let particleIntervals = [];

        // NEW: Function to stop all particle animations
       async function stopParticles() {
            // Clear all active particle generation intervals
            particleIntervals.forEach(clearInterval);
            particleIntervals = []; // Reset the array

            // Remove any existing particle elements from the DOM
            const existingParticles = document.querySelectorAll('.sparkle');
            existingParticles.forEach(p => p.remove());
        }

        // UPDATED: Particle function now resets before starting
        async function part() {
            // First, stop any previously running particle animations
            await stopParticles();

            const divsParticulas = document.querySelectorAll('.divPartculas');
            divsParticulas.forEach(divParticulas => {
                const estilos = window.getComputedStyle(divParticulas);
                const maxParticles = 80; 
                let currentParticles = 0;
                function createSparkle() {
                    if (currentParticles >= maxParticles) return;
                    const sparkle = document.createElement('div');
                    sparkle.classList.add('sparkle');
                    divParticulas.appendChild(sparkle); 
                    currentParticles++;
                    const rect = divParticulas.getBoundingClientRect();
                    const spawnX = Math.random() * rect.width; 
                    const spawnY = Math.random() * rect.height;
                    sparkle.style.opacity = (0.1 + Math.random() * 0.4).toFixed(2);
                    sparkle.style.left = `${spawnX}px`; 
                    sparkle.style.top = `${spawnY}px`;
                    sparkle.style.backgroundColor = `${estilos.borderColor}`;
                    sparkle.style.boxShadow = `0 0 5px 2px ${estilos.borderColor}, 0 0 10px 4px ${estilos.borderColor}`;
                    const size = Math.random() * 1.5 + 0.5;
                    sparkle.style.width = `${size}px`; 
                    sparkle.style.height = `${size}px`;
                    const directionX = (spawnX - rect.width / 2) * 4;
                    const directionY = (spawnY - rect.height / 2) * 4;
                    sparkle.style.setProperty('--x', `${directionX}px`);
                    sparkle.style.setProperty('--y', `${directionY}px`);
                    sparkle.style.setProperty('--r', `${Math.random() * 720}deg`);
                    sparkle.style.setProperty('--duration', `${Math.random() * 15 + 10}s`);
                    sparkle.addEventListener('animationend', () => { 
                        sparkle.remove(); 
                        currentParticles--; 
                    });
                }
                 // Store the interval ID so we can clear it later
                //const intervalId = setInterval(createSparkle, 100);
                //particleIntervals.push(intervalId);
            });
        }

        const periciasData = {
            "üèÉ‚Äç‚ôÇÔ∏è AGILIDADE": { "Acrobacia": "Capacidade de realizar movimentos √°geis e controlados...", "Iniciativa": "Velocidade de rea√ß√£o quando o combate come√ßa...", "Montaria": "Controle de ve√≠culos e montarias complexas...", "Furtividade": "A arte de mover-se sem ser notado...", "Pontaria": "Precis√£o com armas de longo alcance...", "Ladinagem": "Manipula√ß√£o veloz e precisa com as m√£os...", "Reflexos": "Rapidez em reagir a est√≠mulos..." },
            "‚ú® CARISMA": { "Adestramento": "Treinamento e comando de animais...", "Engana√ß√£o": "A arte de manipular a verdade...", "Intimida√ß√£o": "Uso da for√ßa de personalidade para impor medo...", "Persuas√£o": "A habilidade de influenciar e inspirar..." },
            "üß† INTELIG√äNCIA": { "Arcanismo": "Conhecimento das artes m√≠sticas...", "Hist√≥ria": "Mem√≥ria de tempos antigos...", "Investiga√ß√£o": "Capacidade de analisar cen√°rios e reunir pistas...", "Of√≠cio": "Cria√ß√£o, manuten√ß√£o e reparo de objetos...", "Religi√£o": "Conhecimento sobre divindades e rituais...", "Tecnologia": "Compreens√£o de mecanismos e engenhocas..." },
            "üèãÔ∏è FOR√áA": { "Atletismo": "Medida da for√ßa bruta aplicada com t√©cnica...", "Luta": "Combate corpo a corpo com armas simples ou improvisadas..." },
            "ü¶â SABEDORIA": { "Intui√ß√£o": "Habilidade de ler emo√ß√µes e detectar mentiras...", "Percep√ß√£o": "Capacidade de notar detalhes ao redor...", "Medicina": "Conhecimento de curas e tratamento de feridas...", "Natureza": "Sabedoria sobre o mundo natural...", "Sobreviv√™ncia": "A per√≠cia de se adaptar ao mundo selvagem...", "Vontade": "For√ßa interior e estabilidade emocional..." },
            "‚ù§Ô∏è VIGOR": { "Fortitude": "Resist√™ncia f√≠sica e imunol√≥gica do personagem..." }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Refer√™ncias aos elementos do DOM
            const cardForm = document.getElementById('cardForm');
            const spellForm = document.getElementById('spellForm');
            const itemForm = document.getElementById('itemForm');
            
            const cardDisplayArea = document.getElementById('card-display-area');
            const spellCardDisplayArea = document.getElementById('spell-card-display-area');
            const itemCardDisplayArea = document.getElementById('item-card-display-area');

            const submitButton = document.getElementById('submitButton');
            const spellSubmitButton = document.getElementById('spellSubmitButton');
            const itemSubmitButton = document.getElementById('itemSubmitButton');
            const thumbnailList = document.getElementById('thumbnail-list');
            const spellThumbnailList = document.getElementById('spell-thumbnail-list');
            const itemThumbnailList = document.getElementById('item-thumbnail-list');
            
            const formTitle = document.getElementById('form-title');
            const spellFormTitle = document.getElementById('spell-form-title');
            const itemFormTitle = document.getElementById('item-form-title');

            const cardTitleInput = document.getElementById('cardTitle');
            const cardSubTitleInput = document.getElementById('cardSubTitle');
            const cardLevelInput = document.getElementById('cardLevel');

            const characterImageUpload = document.getElementById('characterImageUpload');
            const backgroundImageUpload = document.getElementById('backgroundImageUpload');
            const characterImagePreview = document.getElementById('characterImagePreview');
            const backgroundImagePreview = document.getElementById('backgroundImagePreview');
            
            const vidaInput = document.getElementById('vida');
            const manaInput = document.getElementById('mana');
            const agilidadeInput = document.getElementById('agilidade');
            const carismaInput = document.getElementById('carisma');
            const forcaInput = document.getElementById('forca');
            const inteligenciaInput = document.getElementById('inteligencia');
            const sabedoriaInput = document.getElementById('sabedoria');
            const vigorInput = document.getElementById('vigor');
            
            const periciasCheckboxesContainer = document.getElementById('pericias-checkboxes-container');
            const periciaDescriptionDisplay = document.getElementById('pericia-description-display');
            const periciaDescriptionTitle = document.getElementById('periciaDescriptionTitle');
            const periciaDescriptionText = document.getElementById('periciaDescriptionText');

            const spellImageUpload = document.getElementById('spellImageUpload');
            const spellImagePreview = document.getElementById('spellImagePreview');
            const itemImageUpload = document.getElementById('itemImageUpload');
            const itemImagePreview = document.getElementById('itemImagePreview');


            const splashScreen = document.getElementById('splashScreen');
            const loaderClipRect = document.getElementById('loaderClipRect');
            const progressText = document.getElementById('progressText');
            const mainContent = document.getElementById('mainContent');
            const nav = document.getElementById('nav');

            // Elementos do menu e se√ß√µes
            const showDisplayBtn = document.getElementById('showDisplayBtn');
            const showSpellDisplayBtn = document.getElementById('showSpellDisplayBtn');
            const showItemDisplayBtn = document.getElementById('showItemDisplayBtn');
            const saveDbBtn = document.getElementById('saveDbBtn');
            const cleanupBtn = document.getElementById('cleanupBtn');
            
            const creationSection = document.getElementById('creation-section');
            const displaySection = document.getElementById('display-section');
            const spellDisplaySection = document.getElementById('spell-display-section');
            const itemDisplaySection = document.getElementById('item-display-section');
            const spellCreationSection = document.getElementById('spell-creation-section');
            const itemCreationSection = document.getElementById('item-creation-section');

            const spellContent = document.getElementById('spell-content');
            const itemContent = document.getElementById('item-content');


            const loadingMessages = ['Invocando o Grim√≥rio...', 'Forjando Cart√µes...', 'Organizando o Invent√°rio...', 'Sincronizando com os Reinos...'];

            function updateActiveNav(activeButton) {
                [showDisplayBtn, showSpellDisplayBtn, showItemDisplayBtn].forEach(button => {
                    button.classList.remove('active');
                });
                activeButton.classList.add('active');
            }

            // Fun√ß√µes para controlar a visibilidade das se√ß√µes
            function showDisplayView() {
                displaySection.classList.remove('hidden');
                creationSection.classList.add('hidden');
                spellCreationSection.classList.add('hidden');
                spellDisplaySection.classList.add('hidden');
                itemCreationSection.classList.add('hidden');
                itemDisplaySection.classList.add('hidden');
                updateActiveNav(showDisplayBtn);
                stopParticles();
                part();
            }

            function showCreationView(isEditing = false) {
                creationSection.classList.remove('hidden');
                displaySection.classList.add('hidden');
                spellCreationSection.classList.add('hidden');
                spellDisplaySection.classList.add('hidden');
                itemCreationSection.classList.add('hidden');
                itemDisplaySection.classList.add('hidden');
                stopParticles(); 
                
                if (!isEditing) {
                    formTitle.textContent = "Criar Novo Cart√£o de Personagem";
                    submitButton.textContent = 'Criar Cart√£o';
                    submitButton.classList.add('btn-gradient-pulse');
                    cardForm.reset();
                    showImagePreview(characterImagePreview, null, true);
                    showImagePreview(backgroundImagePreview, null, false);
                    currentEditingCardId = null;
                }
            }
            
            function showSpellCreationView(isEditing = false) {
                spellCreationSection.classList.remove('hidden');
                displaySection.classList.add('hidden');
                creationSection.classList.add('hidden');
                spellDisplaySection.classList.add('hidden');
                itemCreationSection.classList.add('hidden');
                itemDisplaySection.classList.add('hidden');
                stopParticles();

                if (!isEditing) {
                    spellFormTitle.textContent = "Nova Magia ou Habilidade";
                    spellSubmitButton.textContent = 'Salvar Magia';
                    spellForm.reset();
                    showImagePreview(spellImagePreview, null, true);
                    currentEditingSpellId = null;
                }
            }

            function showSpellDisplayView() {
                spellDisplaySection.classList.remove('hidden');
                displaySection.classList.add('hidden');
                creationSection.classList.add('hidden');
                spellCreationSection.classList.add('hidden');
                itemCreationSection.classList.add('hidden');
                itemDisplaySection.classList.add('hidden');
                updateActiveNav(showSpellDisplayBtn);
                stopParticles();
                part();
            }

            function showItemCreationView(isEditing = false) {
                itemCreationSection.classList.remove('hidden');
                displaySection.classList.add('hidden');
                creationSection.classList.add('hidden');
                spellDisplaySection.classList.add('hidden');
                spellCreationSection.classList.add('hidden');
                itemDisplaySection.classList.add('hidden');
                stopParticles();

                if (!isEditing) {
                    itemFormTitle.textContent = "Novo Item";
                    itemSubmitButton.textContent = 'Salvar Item';
                    itemForm.reset();
                    showImagePreview(itemImagePreview, null, true);
                    currentEditingItemId = null;
                }
            }

            function showItemDisplayView() {
                itemDisplaySection.classList.remove('hidden');
                displaySection.classList.add('hidden');
                creationSection.classList.add('hidden');
                spellDisplaySection.classList.add('hidden');
                spellCreationSection.classList.add('hidden');
                itemCreationSection.classList.add('hidden');
                updateActiveNav(showItemDisplayBtn);
                stopParticles();
                part();
            }

            showDisplayBtn.addEventListener('click', showDisplayView);
            showSpellDisplayBtn.addEventListener('click', showSpellDisplayView);
            showItemDisplayBtn.addEventListener('click', showItemDisplayView);

            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!creationSection.classList.contains('hidden')) showDisplayView();
                    if (!spellCreationSection.classList.contains('hidden')) showSpellDisplayView();
                    if (!itemCreationSection.classList.contains('hidden')) showItemDisplayView();
                });
            });

         


            // Fun√ß√µes da tela de splash
            function showSplash() {
                splashScreen.classList.remove('hidden');
                mainContent.classList.add('hidden');
                nav.classList.add('hidden');
                if (loaderClipRect) loaderClipRect.setAttribute('height', '0');
                progressText.textContent = 'Iniciando aventura...';
            }

            function updateProgress(percentage, message) {
                if (loaderClipRect) {
                    const newHeight = 24 * (percentage / 100);
                    loaderClipRect.setAttribute('height', newHeight);
                }
                if (message) {
                    progressText.textContent = `${message} (${percentage}%)`;
                }
            }

            function hideSplash() {
                splashScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                nav.classList.remove('hidden');
                part();
            }

            function populatePericiasCheckboxes() {
                periciasCheckboxesContainer.innerHTML = '';
                for (const attribute in periciasData) {
                    const details = document.createElement('details');
                    details.className = 'bg-gray-700 rounded-lg p-2 transition-all duration-300';
                    details.innerHTML = `<summary class="flex items-center justify-between cursor-pointer font-semibold text-indigo-200"><span>${attribute}</span><svg class="w-4 h-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></summary><div class="mt-2 space-y-2 pl-4 border-l border-gray-600 pericias-list"></div>`;
                    const periciasList = details.querySelector('.pericias-list');
                    details.querySelector('summary').addEventListener('click', () => { setTimeout(() => { details.querySelector('svg').style.transform = details.open ? 'rotate(90deg)' : 'rotate(0deg)'; }, 300); });
                    for (const periciaName in periciasData[attribute]) {
                        const periciaItem = document.createElement('div');
                        periciaItem.className = 'flex items-center pericia-item rounded-md p-1 cursor-pointer';
                        periciaItem.innerHTML = `<input type="checkbox" id="pericia-${periciaName.replace(/\s+/g, '-')}" name="pericia" value="${periciaName}" class="form-checkbox h-4 w-4 text-indigo-500 rounded border-gray-600 focus:ring-indigo-500"><label for="pericia-${periciaName.replace(/\s+/g, '-')}" class="ml-2 text-sm text-gray-200 cursor-pointer">${periciaName}</label>`;
                        periciasList.appendChild(periciaItem);
                        periciaItem.addEventListener('click', (e) => {
                            if (e.target.tagName !== 'INPUT') { const checkbox = periciaItem.querySelector('input'); checkbox.checked = !checkbox.checked; }
                            periciaDescriptionTitle.textContent = periciaName;
                            periciaDescriptionText.textContent = periciasData[attribute][periciaName];
                            periciaDescriptionDisplay.classList.remove('hidden');
                        });
                    }
                    periciasCheckboxesContainer.appendChild(details);
                }
            }

            // Vari√°veis de estado e IndexedDB
            let currentEditingCardId = null;
            let currentEditingSpellId = null;
            let currentEditingItemId = null;

            let db;
            const DB_NAME = 'rpgCreatorDB', DB_VERSION = 3;
            const CARD_STORE_NAME = 'rpgCards';
            const SPELL_STORE_NAME = 'rpgSpells';
            const ITEM_STORE_NAME = 'rpgItems';
            let characterImageFile = null, backgroundImageFile = null, spellImageFile = null, itemImageFile = null;

            function bufferToBlob(buffer, mimeType) { return new Blob([buffer], { type: mimeType }); }
            function rgbToHsl(r, g, b) { r /= 255; g /= 255; b /= 255; let max = Math.max(r, g, b), min = Math.min(r, g, b); let h, s, l = (max + min) / 2; if (max === min) { h = s = 0; } else { let d = max - min; s = l > 0.5 ? d / (2 - max - min) : d / (max + min); switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; } h /= 6; } return [h, s, l]; }
            function hslToRgb(h, s, l) { let r, g, b; if (s === 0) { r = g = b = l; } else { const hue2rgb = (p, q, t) => { if (t < 0) t += 1; if (t > 1) t -= 1; if (t < 1 / 6) return p + (q - p) * 6 * t; if (t < 1 / 2) return q; if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6; return p; }; const q = l < 0.5 ? l * (1 + s) : l + s - l * s; const p = 2 * l - q; r = hue2rgb(p, q, h + 1 / 3); g = hue2rgb(p, q, h); b = hue2rgb(p, q, h - 1 / 3); } return `rgb(${Math.round(r * 255)}, ${Math.round(g * 255)}, ${Math.round(b * 255)})`; }
            function getPredominantColorAndPalette(imageUrl) { return new Promise((resolve, reject) => { const img = new Image(); img.crossOrigin = "Anonymous"; img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0, img.width, img.height); try { const imageData = ctx.getImageData(0, 0, img.width, img.height).data; let r = 0, g = 0, b = 0, count = 0; const step = 4 * 10; for (let i = 0; i < imageData.length; i += step) { r += imageData[i]; g += imageData[i + 1]; b += imageData[i + 2]; count++; } const avgR = Math.floor(r / count), avgG = Math.floor(g / count), avgB = Math.floor(b / count); let [h, s, l] = rgbToHsl(avgR, avgG, avgB); const isLight = l > 0.5; resolve({ cardBg: isLight ? 'rgba(255, 255, 255, 0.8)' : 'rgba(31, 41, 55, 0.9)', highlightColor: hslToRgb(h, Math.min(s*1.5,1), isLight ? Math.max(l*0.7,0.3) : Math.min(l*1.5,0.7)), textColor: isLight ? 'rgb(31, 41, 55)' : 'rgb(243, 244, 246)', borderColor: hslToRgb(h, s, isLight ? Math.max(l*0.7,0.3) : Math.min(l*1.5,0.7)) }); } catch (e) { reject(e); } }; img.onerror = (e) => reject(e); img.src = imageUrl; }); }
            
            function openDatabase() { 
                return new Promise((resolve, reject) => { 
                    const req = indexedDB.open(DB_NAME, DB_VERSION); 
                    req.onsuccess = (e) => { db = e.target.result; resolve(db); }; 
                    req.onerror = (e) => reject(e.target.error); 
                    req.onupgradeneeded = (e) => { 
                        db = e.target.result; 
                        if (!db.objectStoreNames.contains(CARD_STORE_NAME)) { 
                            db.createObjectStore(CARD_STORE_NAME, { keyPath: 'id' }); 
                        }
                        if (!db.objectStoreNames.contains(SPELL_STORE_NAME)) {
                            db.createObjectStore(SPELL_STORE_NAME, { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains(ITEM_STORE_NAME)) {
                            db.createObjectStore(ITEM_STORE_NAME, { keyPath: 'id' });
                        }
                    }; 
                }); 
            }
            
            async function saveData(storeName, data) { 
                const tx = db.transaction([storeName], 'readwrite'); 
                const store = tx.objectStore(storeName); 
                return new Promise((resolve, reject) => { 
                    const req = store.put(data); 
                    req.onsuccess = () => resolve(); 
                    req.onerror = (e) => reject(e.target.error); 
                }); 
            }
            async function getData(storeName) { 
                const tx = db.transaction([storeName], 'readonly'); 
                const store = tx.objectStore(storeName); 
                return new Promise((resolve, reject) => { 
                    const req = store.getAll(); 
                    req.onsuccess = (e) => resolve(e.target.result); 
                    req.onerror = (e) => reject(e.target.error); 
                }); 
            }
            async function removeData(storeName, id) { 
                const tx = db.transaction([storeName], 'readwrite'); 
                const store = tx.objectStore(storeName); 
                return new Promise((resolve, reject) => { 
                    const req = store.delete(id); 
                    req.onsuccess = () => resolve(); 
                    req.onerror = (e) => reject(e.target.error); 
                }); 
            }

            async function deleteOldDatabases() {
                try {
                    if (indexedDB.databases) {
                        const databases = await indexedDB.databases();
                        for (const dbInfo of databases) {
                            if (dbInfo.name !== DB_NAME) {
                                console.log(`Excluindo banco de dados antigo: ${dbInfo.name}`);
                                indexedDB.deleteDatabase(dbInfo.name);
                            }
                        }
                    }
                } catch (e) {
                    console.error("Seu navegador n√£o suporta a listagem de bancos de dados. A limpeza autom√°tica n√£o funcionar√°.", e);
                }
            }

            // --- Fun√ß√µes CRUD para Cart√µes de Personagem ---
            async function editCard(cardId) {
                const allCards = await getData(CARD_STORE_NAME);
                const cardData = allCards.find(card => card.id === cardId);
                if (!cardData) return;
                
                showCreationView(true);
                formTitle.textContent = `Editando: ${cardData.title}`;
                
                currentEditingCardId = cardId;
                cardTitleInput.value = cardData.title;
                cardSubTitleInput.value = cardData.subTitle;
                cardLevelInput.value = cardData.level;
                vidaInput.value = cardData.attributes.vida;
                manaInput.value = cardData.attributes.mana;
                agilidadeInput.value = cardData.attributes.agilidade;
                carismaInput.value = cardData.attributes.carisma;
                forcaInput.value = cardData.attributes.forca;
                inteligenciaInput.value = cardData.attributes.inteligencia;
                sabedoriaInput.value = cardData.attributes.sabedoria;
                vigorInput.value = cardData.attributes.vigor;

                document.querySelectorAll('#pericias-checkboxes-container input[type="checkbox"]').forEach(cb => cb.checked = false);
                if (Array.isArray(cardData.attributes.pericias)) {
                    cardData.attributes.pericias.forEach(periciaName => {
                        const checkbox = document.getElementById(`pericia-${periciaName.replace(/\s+/g, '-')}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                if (cardData.image) {
                    const imageBlob = bufferToBlob(cardData.image, cardData.imageMimeType);
                    showImagePreview(characterImagePreview, URL.createObjectURL(imageBlob), true);
                    characterImageFile = null;
                } else { showImagePreview(characterImagePreview, null, true); }

                if (cardData.backgroundImage) {
                    const backgroundBlob = bufferToBlob(cardData.backgroundImage, cardData.backgroundMimeType);
                    showImagePreview(backgroundImagePreview, URL.createObjectURL(backgroundBlob), false);
                } else { showImagePreview(backgroundImagePreview, null, false); }

                characterImageUpload.value = null;
                backgroundImageUpload.value = null;
                submitButton.textContent = 'Salvar Edi√ß√£o';
                submitButton.classList.remove('btn-gradient-pulse');
            }
            
            function createAddThumbnail(type) {
                const thumb = document.createElement('div');
                let colorClass = 'border-indigo-500 hover:bg-indigo-500';
                if(type === 'spell') colorClass = 'border-teal-500 hover:bg-teal-500';
                if(type === 'item') colorClass = 'border-amber-500 hover:bg-amber-500';

                thumb.className = `relative w-20 h-24 rounded-lg flex items-center justify-center border-2 border-dashed ${colorClass} cursor-pointer transition-colors duration-200`;
                thumb.style.minWidth = '5rem';
                thumb.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>`;
                
                let clickHandler;
                if(type === 'character') clickHandler = () => showCreationView(false);
                if(type === 'spell') clickHandler = () => showSpellCreationView(false);
                if(type === 'item') clickHandler = () => showItemCreationView(false);

                thumb.addEventListener('click', clickHandler);
                return thumb;
            }

            async function renderCardsAndThumbnails() {
                thumbnailList.innerHTML = '';
                const allCards = await getData(CARD_STORE_NAME);
                cardDisplayArea.innerHTML = '<p class="text-gray-400">Selecione um personagem na lista acima para ver os detalhes.</p>';
                
                let cardsLoaded = 0;
                for (const cardData of allCards) {
                    let imageURL = 'https://placehold.co/160x160/E5E7EB/4B5563?text=Personagem';
                    let backgroundURL = 'https://placehold.co/400x600/1e293b/d1d5db?text=Fundo';
                    if (cardData.image) imageURL = URL.createObjectURL(bufferToBlob(cardData.image, cardData.imageMimeType));
                    if (cardData.backgroundImage) backgroundURL = URL.createObjectURL(bufferToBlob(cardData.backgroundImage, cardData.backgroundMimeType));
                    
                    const thumbnail = createThumbnailElement({...cardData, imageURL, backgroundURL});
                    thumbnailList.appendChild(thumbnail);
                    
                    cardsLoaded++;
                    const percentage = Math.round((cardsLoaded / allCards.length) * 33);
                    updateProgress(percentage, loadingMessages[Math.floor(Math.random() * loadingMessages.length)]);
                }

                thumbnailList.appendChild(createAddThumbnail('character'));

                if (allCards.length > 0) {
                     await displayCard(allCards[0].id);
                } else {
                     cardDisplayArea.innerHTML = '<p class="text-gray-400 text-center">Nenhum personagem encontrado. Clique no bot√£o + para criar um.</p>';
                }
            }
            
            // NOVA FUN√á√ÉO: Para exibir um card com anima√ß√£o
            async function displayCard(cardId) {
                cardDisplayArea.innerHTML = ''; // Limpa a √°rea
                const allCards = await getData(CARD_STORE_NAME);
                const fullCardData = allCards.find(c => c.id === cardId);
                if (!fullCardData) return;

                let imageURL = 'https://placehold.co/160x160/E5E7EB/4B5563?text=Personagem';
                let backgroundURL = 'https://placehold.co/400x600/1e293b/d1d5db?text=Fundo';
                if (fullCardData.image) imageURL = URL.createObjectURL(bufferToBlob(fullCardData.image, fullCardData.imageMimeType));
                if (fullCardData.backgroundImage) backgroundURL = URL.createObjectURL(bufferToBlob(fullCardData.backgroundImage, fullCardData.backgroundMimeType));

                const cardElement = await createCardElement({ ...fullCardData, imageURL, backgroundURL });
                
                cardDisplayArea.appendChild(cardElement);
                // Adiciona a classe 'visible' para iniciar a anima√ß√£o de entrada
                setTimeout(() => cardElement.classList.add('visible'), 10);

                await stopParticles();
                part();
            }

            async function createCardElement(cardData) {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'card-wrapper flex flex-col items-center gap-4';
                const cardDiv = document.createElement('div');
                cardDiv.className = 'w-full h-auto rounded-3xl shadow-2xl rpg-card';
                cardDiv.dataset.cardId = cardData.id;
                cardDiv.style.backgroundImage = `url(${cardData.backgroundURL})`;
                let palette = { cardBg: 'rgba(31,41,55,0.9)', highlightColor: '#6366f1', textColor: '#e5e7eb', borderColor: '#4b5563' };
                if (cardData.backgroundURL && !cardData.backgroundURL.includes('placehold.co')) {
                    try { palette = await getPredominantColorAndPalette(cardData.backgroundURL); } catch (e) { console.error('Falha ao gerar paleta.', e); }
                }
                const periciasString = Array.isArray(cardData.attributes.pericias) && cardData.attributes.pericias.length > 0 ? cardData.attributes.pericias.join(', ') : 'Nenhuma';
                cardDiv.innerHTML = `
                    <div class="card-3d-container">
                        <div class="card-3d divPartculas">
                            <div class="card-front" style="border-color: ${palette.borderColor}">
                                <div class="rounded-3xl relative w-full h-full p-4 ex-max" style="background-image:url(${cardData.backgroundURL}) !important; height: 650px; display: flex; flex-direction: column; align-items: center; background-color: rgb(0 0 0 / 50%); justify-content: space-between;">
                                    <div class="absolute top-4 left-4 rounded-full w-14 h-14 flex items-center justify-center font-bold" style="z-index: 1; border: 2px solid ${palette.highlightColor}; background-color: #1f2937; color: ${palette.textColor};"><small style="background: #1f2937; border: 2px solid ${palette.highlightColor}; border-bottom: 0; border-right: 0;">PM</small>${cardData.attributes.mana || '?'}</div>
                                    <div class="absolute top-4 right-4 rounded-full w-14 h-14 flex items-center justify-center font-bold" style="z-index: 1;border: 2px solid ${palette.highlightColor}; background-color: #1f2937; color: ${palette.textColor};"><small style="background: #1f2937; left: auto; right: -10px; border: 2px solid ${palette.highlightColor}; border-bottom: 0; border-left: 0;">PV</small>${cardData.attributes.vida || '?'}</div>
                                    <div class="text-center" style="width: 60%;"><h3 class="text-2xl font-bold" style="color: ${palette.highlightColor};">${cardData.title}</h3><div class="rpg-card-title-divider" style="background: linear-gradient(to right, transparent, ${palette.borderColor}, transparent); width: 100%"></div><p class="text-sm italic" style="color: ${palette.highlightColor};">${cardData.subTitle}</p></div>
                                    <div class="wave-container flex justify-center img-max" style="position: relative; width: 200px !important; height: 200px;"><img style="border-color: ${palette.borderColor}; z-index: 1; height: 200px" src="${cardData.imageURL}" onerror="this.src='https://placehold.co/160x160/E5E7EB/4B5563?text=Personagem';" alt="Imagem do personagem" class="object-cover rounded-full border-4 border-white shadow-lg w-full h-full"></div>
                                    <div class="p-3 rounded-3xl text-center w-full rpg-card-frame" style="--card-bg-color: ${palette.cardBg}; z-index: 1; --text-color: ${palette.textColor}; --border-color: ${palette.borderColor};">
                                        <h4 class="text-base font-bold" style="color: ${palette.textColor};">N√≠vel: <span style="color: ${palette.highlightColor};">${cardData.level}</span></h4>
                                        <div class="flex items-center justify-center w-full"><div class="rpg-card-title-divider" style="background: linear-gradient(to right, transparent, ${palette.borderColor}, transparent);"></div></div>
                                        ${Object.entries(cardData.attributes).filter(([key]) => !['vida', 'mana', 'pericias'].includes(key)).map(([key, value]) => `<div class="mt-2 flex items-center space-x-2 text-xs"><span class="font-bold w-8">${key.slice(0,3).toUpperCase()}</span><div class="stat-bar flex-grow" style="margin-top: 0"><div class="stat-fill" style="width: ${(value * 100) / 3}%; background: ${palette.borderColor}"></div></div><span class="text-xs font-bold ml-auto">${value} / 3</span></div>`).join('')}
                                        <div class="flex flex-col gap-2 mt-4"><div class="flex items-center justify-center w-full"><div class="rpg-card-title-divider" style="background: linear-gradient(to right, transparent, ${palette.borderColor}, transparent);"></div></div><p class="text-xs text-gray-400 italic">Per√≠cias</p><p class="text-xs text-gray-400 italic" style="font-size: 11px;">${periciasString}</p></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-back divPartculas" style="background-image:url(${cardData.backgroundURL}) !important; background-size: cover !important; background-color: rgb(0 0 0 / 50%);background-blend-mode: multiply;">
                                <div class="back-content" style="border: 5px solid ${palette.borderColor};">
                                    <h2></h2>
                                    <p></p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'flex justify-center space-x-2 w-full';
                buttonsDiv.innerHTML = `<button class="w-1/3 py-3 px-4 text-sm font-bold text-white transition-colors duration-200 edit-btn" data-card-id="${cardData.id}" style="border-radius: 50px 0 0 50px; background-color: #23426d;">Editar</button><button class="w-1/3 py-3 px-4 text-sm font-bold text-white transition-colors duration-200 remove-btn" data-card-id="${cardData.id}" style="border-radius: 0; background-color: ${palette.highlightColor};">Excluir</button><button class="w-1/3 py-3 px-4 text-sm font-bold text-white transition-colors duration-200 fullscreen-btn" data-card-id="${cardData.id}" style="border-radius: 0 50px 50px 0; background-color: #23426d;">Expandir</button>`;
                cardWrapper.appendChild(cardDiv);

                const card3d = cardDiv.querySelector('.card-3d');
                if(card3d)
                {
                    card3d.addEventListener('click',()=> card3d.style.transform=card3d.style.transform==='rotateY(180deg)'?'rotateY(0deg)':'rotateY(180deg)');
                }
                cardWrapper.appendChild(buttonsDiv);
                return cardWrapper;
            }

            function createThumbnailElement(cardData) {
                const thumb = document.createElement('div');
                thumb.className = 'relative w-20 h-24 rounded-lg overflow-hidden shadow-lg border-2 border-gray-400 cursor-pointer hover:border-indigo-500 transition-colors duration-200';
                thumb.dataset.cardId = cardData.id;
                thumb.style.backgroundImage = `url(${cardData.backgroundURL})`;
                thumb.style.backgroundSize = 'cover';
                thumb.style.backgroundPosition = 'center';
                thumb.style.minWidth = '5rem';
                thumb.innerHTML = `<div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center"><img src="${cardData.imageURL}" onerror="this.src='https://placehold.co/40x40/E5E7EB/4B5563?text=P';" alt="Miniatura" class="w-10 h-10 object-cover rounded-full border-2 border-white"></div><div class="absolute bottom-1 left-1 bg-gray-800 text-white text-xs px-2 py-1 rounded-full font-bold">Lv.${cardData.level}</div>`;
                
                // MODIFICADO: Chama a nova fun√ß√£o displayCard
                thumb.addEventListener('click', () => displayCard(cardData.id));
                return thumb;
            }

            async function removeCard(cardId) { 
                await removeData(CARD_STORE_NAME, cardId); 
                await renderCardsAndThumbnails(); 
            }
            
            // --- Fun√ß√µes CRUD para Magias/Habilidades ---

            async function renderSpellCards() {
                spellThumbnailList.innerHTML = '';
                const allSpells = await getData(SPELL_STORE_NAME);
                spellCardDisplayArea.innerHTML = '<p class="text-gray-400">Selecione uma magia na lista acima para ver os detalhes.</p>';

                let spellsLoaded = 0;
                for (const spellData of allSpells) {
                    let imageURL = 'https://placehold.co/160x160/14b8a6/1f2937?text=Magia';
                    if (spellData.image) imageURL = URL.createObjectURL(bufferToBlob(spellData.image, spellData.imageMimeType));
                    
                    const spellThumbnail = createSpellThumbnailElement({...spellData, imageURL});
                    spellThumbnailList.appendChild(spellThumbnail);

                    spellsLoaded++;
                    const percentage = 33 + Math.round((spellsLoaded / allSpells.length) * 33);
                    updateProgress(percentage, loadingMessages[Math.floor(Math.random() * loadingMessages.length)]);
                }

                spellThumbnailList.appendChild(createAddThumbnail('spell'));

                if (allSpells.length > 0) {
                    await displaySpell(allSpells[0].id);
                } else {
                    spellCardDisplayArea.innerHTML = '<p class="text-gray-400 text-center">Nenhuma magia encontrada. Clique no bot√£o + para criar uma.</p>';
                }
            }
            
            async function displaySpell(spellId) {
                spellCardDisplayArea.innerHTML = ''; // Limpa a √°rea
                const allSpells = await getData(SPELL_STORE_NAME);
                const fullSpellData = allSpells.find(s => s.id === spellId);
                if (!fullSpellData) return;

                let imageURL = 'https://placehold.co/160x160/14b8a6/1f2937?text=Magia';
                if (fullSpellData.image) imageURL = URL.createObjectURL(bufferToBlob(fullSpellData.image, fullSpellData.imageMimeType));

                const spellCardElement = await createSpellCardElement({ ...fullSpellData, imageURL });
                
                spellCardDisplayArea.appendChild(spellCardElement);
                setTimeout(() => spellCardElement.classList.add('visible'), 10);

                await stopParticles();
                part();
            }

            async function createSpellCardElement(spellData) {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'card-wrapper flex flex-col items-center gap-4';
                const cardDiv = document.createElement('div');
                cardDiv.className = 'w-full h-auto rounded-3xl shadow-2xl rpg-card';
                cardDiv.dataset.spellId = spellData.id;
                
                let palette = { cardBg: 'rgba(17, 24, 39, 0.9)', highlightColor: '#2dd4bf', textColor: '#e5e7eb', borderColor: '#0d9488' };
                if (spellData.imageURL && !spellData.imageURL.includes('placehold.co')) {
                    try { 
                        palette = await getPredominantColorAndPalette(spellData.imageURL); 
                    } catch (e) { 
                        console.error('Falha ao gerar paleta para magia.', e); 
                    }
                }

                cardDiv.style.backgroundImage = `url(${spellData.imageURL})`;
                cardDiv.style.backgroundColor="rgb(0 0 0 / 50%)";
                cardDiv.style.backgroundBlendMode="multiply";

                cardDiv.innerHTML = `
                    <div class="card-3d-container">
                        <div class="card-3d divPartculas">
                            <div class="card-front" style="border-color: ${palette.borderColor};background-image:url(${spellData.imageURL}) !important; background-position: center; background-size: cover">
                                <div class="rounded-3xl relative w-full h-full p-4 ex-max" style="background: linear-gradient(-180deg, #000000ba, #00000085, transparent, #00000085, #000000ba); height: 650px; display: flex; flex-direction: column; align-items: center; justify-content: space-between;    background-blend-mode: multiply;">
                                    <div class="text-center w-full"><h3 class="text-2xl font-bold" style="color: ${palette.highlightColor};">${spellData.name}</h3><div class="rpg-card-title-divider" style="background: linear-gradient(to right, transparent, ${palette.borderColor}, transparent); width: 100%"></div></div>
                                     <div class="text-xs text-gray-400 mb-3" style="position: absolute; margin-top: 55px; left: 15px;">
                                            <p class="text-left"><strong>Execu√ß√£o:</strong> ${spellData.execution || '-'}</p>
                                            <p class="text-left"><strong>Alcance:</strong> ${spellData.range || '-'}</p>
                                            <p class="text-left"><strong>Alvo:</strong> ${spellData.target || '-'}</p>
                                            <p class="text-left"><strong>Dura√ß√£o:</strong> ${spellData.duration || '-'}</p>
                                    </div>
                                    <div class="w-full">                                       
                                        <div class="text-sm text-left" style="display: flex; flex-direction: row; overflow-y: scroll;gap: 12px;    scroll-snap-type: x mandatory;">                                             
                                            <div class="mb-4 p-3 rounded-3xl w-full" style="scroll-snap-align: start;flex-shrink: 0;min-width: 100%; border-color: ${palette.borderColor}; position: relative; z-index: 1; overflow-y: visible;">
                                                <h4 class="font-semibold text-gray-300">Descri√ß√£o</h4>
                                                <p class="text-gray-300 text-xs">${spellData.description || 'Nenhuma descri√ß√£o.'}</p>
                                            </div>                                            
                                            <div class="mb-4 p-3 rounded-3xl w-full" style="scroll-snap-align: start;flex-shrink: 0;min-width: 100%; border-color: ${palette.borderColor}; position: relative; z-index: 1; overflow-y: visible;">
                                                <h4 class="font-semibold text-gray-300">Aprimorar</h4>
                                                <p class="text-gray-300 text-xs">${spellData.enhance}</p>
                                            </div>
                                            <div class="p-3 rounded-3xl w-full" style="scroll-snap-align: start;flex-shrink: 0;flex-shrink: 0;min-width: 100%; border-color: ${palette.borderColor}; position: relative; z-index: 1; overflow-y: visible;">
                                                <h4 class="font-semibold text-gray-300">Verdadeiro</h4>
                                                <p class="text-gray-300 text-xs">${spellData.true}</p>
                                            </div>                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-back divPartculas" style="background-image:url(${spellData.imageURL}) !important; background-size: cover !important; background-color: rgb(0 0 0 / 50%);background-blend-mode: multiply;">
                                <div class="back-content" style="border: 5px solid ${palette.borderColor};">
                                    <h2></h2>
                                    <p></p>
                                </div>
                            </div>
                        </div>
                    </div>`;

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'flex justify-center space-x-2 w-full';
                buttonsDiv.innerHTML = `<button class="w-1/3 py-3 px-4 text-sm font-bold text-white transition-colors duration-200 edit-spell-btn" data-spell-id="${spellData.id}" style="border-radius: 50px 0 0 50px; background-color: #23426d;">Editar</button><button class="w-1/3 py-3 px-4 text-sm font-bold text-white transition-colors duration-200 remove-spell-btn" data-spell-id="${spellData.id}" style="border-radius: 0; background-color: #dc2626;">Excluir</button><button class="w-1/3 py-3 px-4 text-sm font-bold text-white transition-colors duration-200 fullscreen-spell-btn" data-spell-id="${spellData.id}" style="border-radius: 0 50px 50px 0; background-color: #23426d;">Expandir</button>`;
                
                cardWrapper.appendChild(cardDiv);
                 const card3d = cardDiv.querySelector('.card-3d');
                if(card3d){card3d.addEventListener('click',()=>card3d.style.transform=card3d.style.transform==='rotateY(180deg)'?'rotateY(0deg)':'rotateY(180deg)');}
                cardWrapper.appendChild(buttonsDiv);
                return cardWrapper;
            }

            function createSpellThumbnailElement(spellData) {
                const thumb = document.createElement('div');
                thumb.className = 'relative w-20 h-24 rounded-lg overflow-hidden shadow-lg border-2 border-gray-400 cursor-pointer hover:border-teal-500 transition-colors duration-200';
                thumb.dataset.spellId = spellData.id;
                thumb.style.background = 'linear-gradient(45deg, #0f172a, #1e293b)';
                thumb.style.minWidth = '5rem';
                thumb.innerHTML = `<div class="absolute inset-0 bg-opacity-40 flex items-center justify-center" style="background: url(${spellData.imageURL}); background-size: cover;"><img src="${spellData.imageURL}" onerror="this.src='https://placehold.co/40x40/14b8a6/1f2937?text=M';" alt="Miniatura da Magia" class="w-10 h-10 object-cover rounded-full border-2 border-teal-400"></div>`;
                
                thumb.addEventListener('click', () => displaySpell(spellData.id));
                return thumb;
            }

            async function editSpell(spellId) {
                const allSpells = await getData(SPELL_STORE_NAME);
                const spellData = allSpells.find(s => s.id === spellId);
                if (!spellData) return;

                showSpellCreationView(true);
                spellFormTitle.textContent = `Editando: ${spellData.name}`;
                currentEditingSpellId = spellId;

                document.getElementById('spellName').value = spellData.name;
                document.getElementById('spellExecution').value = spellData.execution;
                document.getElementById('spellRange').value = spellData.range;
                document.getElementById('spellTarget').value = spellData.target;
                document.getElementById('spellDuration').value = spellData.duration;
                document.getElementById('spellDescription').value = spellData.description;
                document.getElementById('spellEnhance').value = spellData.enhance;
                document.getElementById('spellTrue').value = spellData.true;
                
                if (spellData.image) {
                    const imageBlob = bufferToBlob(spellData.image, spellData.imageMimeType);
                    showImagePreview(spellImagePreview, URL.createObjectURL(imageBlob), true);
                    spellImageFile = null;
                } else {
                    showImagePreview(spellImagePreview, null, true);
                }
                spellImageUpload.value = null;
                spellSubmitButton.textContent = 'Salvar Edi√ß√£o';
            }

            async function removeSpell(spellId) {
                await removeData(SPELL_STORE_NAME, spellId);
                await renderSpellCards();
            }

            spellCardDisplayArea.addEventListener('click', e => {
                const spellId = e.target.dataset.spellId;
                if (!spellId) return;

                if (e.target.classList.contains('edit-spell-btn')) {
                    editSpell(spellId);
                } else if (e.target.classList.contains('remove-spell-btn')) {
                    removeSpell(spellId);
                } else if (e.target.classList.contains('fullscreen-spell-btn')) {
                    const cardDiv = e.target.closest('.card-wrapper').querySelector('.rpg-card');
                    if (document.fullscreenElement) document.exitFullscreen();
                    else cardDiv.requestFullscreen().catch(err => console.error(`Erro: ${err.message}`));
                }
            });

            // --- Fun√ß√µes CRUD para Itens ---
            async function renderItemsAndThumbnails() {
                itemThumbnailList.innerHTML = '';
                const allItems = await getData(ITEM_STORE_NAME);
                itemCardDisplayArea.innerHTML = '<p class="text-gray-400">Selecione um item na lista acima para ver os detalhes.</p>';

                let itemsLoaded = 0;
                for (const itemData of allItems) {
                    let imageURL = 'https://placehold.co/160x160/f59e0b/422006?text=Item';
                    if (itemData.image) imageURL = URL.createObjectURL(bufferToBlob(itemData.image, itemData.imageMimeType));

                    const itemThumbnail = createItemThumbnailElement({ ...itemData, imageURL });
                    itemThumbnailList.appendChild(itemThumbnail);

                    itemsLoaded++;
                    const percentage = 66 + Math.round((itemsLoaded / allItems.length) * 34);
                    updateProgress(percentage, loadingMessages[Math.floor(Math.random() * loadingMessages.length)]);
                }
                
                itemThumbnailList.appendChild(createAddThumbnail('item'));

                if (allItems.length > 0) {
                    await displayItem(allItems[0].id);
                } else {
                    itemCardDisplayArea.innerHTML = '<p class="text-gray-400 text-center">Nenhum item encontrado. Clique no bot√£o + para criar um.</p>';
                }
            }

            async function displayItem(itemId) {
                itemCardDisplayArea.innerHTML = ''; // Limpa a √°rea
                const allItems = await getData(ITEM_STORE_NAME);
                const fullItemData = allItems.find(i => i.id === itemId);
                if (!fullItemData) return;

                let imageURL = 'https://placehold.co/160x160/f59e0b/422006?text=Item';
                if (fullItemData.image) imageURL = URL.createObjectURL(bufferToBlob(fullItemData.image, fullItemData.imageMimeType));

                const itemCardElement = await createItemCardElement({ ...fullItemData, imageURL });

                itemCardDisplayArea.appendChild(itemCardElement);
                setTimeout(() => itemCardElement.classList.add('visible'), 10);

                await stopParticles();
                part();
            }

            async function createItemCardElement(itemData) {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'card-wrapper flex flex-col items-center gap-4';
                const cardDiv = document.createElement('div');
                cardDiv.className = 'w-full h-auto rounded-3xl shadow-2xl rpg-card';
                cardDiv.dataset.itemId = itemData.id;
                
                let palette = { cardBg: 'rgba(17, 24, 39, 0.9)', highlightColor: '#f59e0b', textColor: '#e5e7eb', borderColor: '#d97706' };
                if (itemData.imageURL && !itemData.imageURL.includes('placehold.co')) {
                    try { palette = await getPredominantColorAndPalette(itemData.imageURL); } catch(e) { console.error('Falha ao gerar paleta para item.', e); }
                }

                cardDiv.style.backgroundImage = `url(${itemData.imageURL})`;
                cardDiv.style.backgroundColor="rgb(0 0 0 / 50%)";
                cardDiv.style.backgroundBlendMode="multiply";

                 cardDiv.innerHTML = `
                    <div class="card-3d-container">
                        <div class="card-3d divPartculas">
                            <div class="card-front" style="border-color: ${palette.borderColor};background-image:url(${itemData.imageURL}) !important; background-position: center; background-size: cover">
                                <div class="rounded-3xl relative w-full h-full p-4 ex-max" style="background: linear-gradient(-180deg, #000000ba, #00000085, transparent, #00000085, #000000ba); height: 650px; display: flex; flex-direction: column; align-items: center; justify-content: space-between;    background-blend-mode: multiply;">
                                    <div class="text-center w-full"><h3 class="text-2xl font-bold" style="color: ${palette.highlightColor};">${itemData.name}</h3><div class="rpg-card-title-divider" style="background: linear-gradient(to right, transparent, ${palette.borderColor}, transparent); width: 100%"></div></div>
                                     <div class="text-xs text-gray-400 mb-3" style="position: absolute; margin-top: 55px; left: 15px;">
                                            <p class="text-left"><strong>Tipo:</strong> ${itemData.type || '-'}</p>
                                            <p class="text-left"><strong>Dano:</strong> ${itemData.damage || '-'}</p>
                                            <p class="text-left"><strong>Carga:</strong> ${itemData.charge || '-'}</p>
                                            <p class="text-left"><strong>Pr√©-requisito:</strong> ${itemData.prerequisite || '-'}</p>
                                    </div>
                                    <div class="w-full">                                       
                                        <div class="text-sm text-left" style="display: flex; flex-direction: row; overflow-y: scroll;gap: 12px;    scroll-snap-type: x mandatory;">                                             
                                            <div class="mb-4 p-3 rounded-3xl w-full" style="scroll-snap-align: start;flex-shrink: 0;min-width: 100%; border-color: ${palette.borderColor}; position: relative; z-index: 1; overflow-y: visible;">
                                                <h4 class="font-semibold text-gray-300">Efeito</h4>
                                                <p class="text-gray-300 text-xs">${itemData.effect || 'Nenhum efeito.'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-back divPartculas" style="background-image:url(${itemData.imageURL}) !important; background-size: cover !important; background-color: rgb(0 0 0 / 50%);background-blend-mode: multiply;">
                                <div class="back-content" style="border: 5px solid ${palette.borderColor};">
                                    <h2></h2>
                                    <p></p>
                                </div>
                            </div>
                        </div>
                    </div>`;

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'flex justify-center space-x-2 w-full';
                buttonsDiv.innerHTML = `<button class="w-1/3 py-3 px-4 text-sm font-bold text-white transition-colors duration-200 edit-item-btn" data-item-id="${itemData.id}" style="border-radius: 50px 0 0 50px; background-color: #23426d;">Editar</button><button class="w-1/3 py-3 px-4 text-sm font-bold text-white transition-colors duration-200 remove-item-btn" data-item-id="${itemData.id}" style="border-radius: 0; background-color: #dc2626;">Excluir</button><button class="w-1/3 py-3 px-4 text-sm font-bold text-white transition-colors duration-200 fullscreen-item-btn" data-item-id="${itemData.id}" style="border-radius: 0 50px 50px 0; background-color: #23426d;">Expandir</button>`;
                
                cardWrapper.appendChild(cardDiv);
                const card3d = cardDiv.querySelector('.card-3d');
                if(card3d){card3d.addEventListener('click',()=>card3d.style.transform=card3d.style.transform==='rotateY(180deg)'?'rotateY(0deg)':'rotateY(180deg)');}
                cardWrapper.appendChild(buttonsDiv);
                return cardWrapper;
            }
            
            function createItemThumbnailElement(itemData) {
                const thumb = document.createElement('div');
                thumb.className = 'relative w-20 h-24 rounded-lg overflow-hidden shadow-lg border-2 border-gray-400 cursor-pointer hover:border-amber-500 transition-colors duration-200';
                thumb.dataset.itemId = itemData.id;
                thumb.style.background = 'linear-gradient(45deg, #272011, #422006)';
                thumb.style.minWidth = '5rem';
                thumb.innerHTML = `<div class="absolute inset-0 bg-opacity-40 flex items-center justify-center" style="background: url(${itemData.imageURL}); background-size: cover;"><img src="${itemData.imageURL}" onerror="this.src='https://placehold.co/40x40/f59e0b/422006?text=I';" alt="Miniatura do Item" class="w-10 h-10 object-cover rounded-full border-2 border-amber-400"></div>`;
                
                thumb.addEventListener('click', () => displayItem(itemData.id));
                return thumb;
            }

            async function editItem(itemId) {
                const allItems = await getData(ITEM_STORE_NAME);
                const itemData = allItems.find(i => i.id === itemId);
                if (!itemData) return;

                showItemCreationView(true);
                itemFormTitle.textContent = `Editando: ${itemData.name}`;
                currentEditingItemId = itemId;

                document.getElementById('itemName').value = itemData.name;
                document.getElementById('itemType').value = itemData.type;
                document.getElementById('itemDamage').value = itemData.damage;
                document.getElementById('itemCharge').value = itemData.charge;
                document.getElementById('itemPrerequisite').value = itemData.prerequisite;
                document.getElementById('itemEffect').value = itemData.effect;
                
                if (itemData.image) {
                    const imageBlob = bufferToBlob(itemData.image, itemData.imageMimeType);
                    showImagePreview(itemImagePreview, URL.createObjectURL(imageBlob), true);
                    itemImageFile = null;
                } else {
                    showImagePreview(itemImagePreview, null, true);
                }
                itemImageUpload.value = null;
                itemSubmitButton.textContent = 'Salvar Edi√ß√£o';
            }

            async function removeItem(itemId) {
                await removeData(ITEM_STORE_NAME, itemId);
                await renderItemsAndThumbnails();
            }

            itemCardDisplayArea.addEventListener('click', e => {
                const itemId = e.target.dataset.itemId;
                if (!itemId) return;

                if (e.target.classList.contains('edit-item-btn')) {
                    editItem(itemId);
                } else if (e.target.classList.contains('remove-item-btn')) {
                    removeItem(itemId);
                } else if (e.target.classList.contains('fullscreen-item-btn')) {
                    const cardDiv = e.target.closest('.card-wrapper').querySelector('.rpg-card');
                    if (document.fullscreenElement) document.exitFullscreen();
                    else cardDiv.requestFullscreen().catch(err => console.error(`Erro: ${err.message}`));
                }
            });


            // --- Gerenciamento de Imagens e Formul√°rios ---
            characterImageUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { characterImageFile = file; showImagePreview(characterImagePreview, URL.createObjectURL(file), true); } });
            backgroundImageUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { backgroundImageFile = file; showImagePreview(backgroundImagePreview, URL.createObjectURL(file), false); } });
            spellImageUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { spellImageFile = file; showImagePreview(spellImagePreview, URL.createObjectURL(file), true); } });
            itemImageUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { itemImageFile = file; showImagePreview(itemImagePreview, URL.createObjectURL(file), true); } });


            function showImagePreview(element, url, isImageElement) { if (url) { if (isImageElement) element.src = url; else element.style.backgroundImage = `url(${url})`; element.classList.remove('hidden'); } else { element.classList.add('hidden'); } }
            function readFileAsArrayBuffer(file) { return new Promise((resolve, reject) => { if (!file) { resolve(null); return; } const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.onerror = (e) => reject(e.target.error); reader.readAsArrayBuffer(file); }); }

            cardForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedPericias = Array.from(document.querySelectorAll('#pericias-checkboxes-container input:checked')).map(cb => cb.value);
                const attributes = { vida: vidaInput.value, mana: manaInput.value, agilidade: agilidadeInput.value, carisma: carismaInput.value, forca: forcaInput.value, inteligencia: inteligenciaInput.value, sabedoria: sabedoriaInput.value, vigor: vigorInput.value, pericias: selectedPericias };
                let cardData;
                if (currentEditingCardId) {
                    const allCards = await getData(CARD_STORE_NAME);
                    cardData = allCards.find(card => card.id === currentEditingCardId);
                    if (!cardData) return;
                    Object.assign(cardData, { title: cardTitleInput.value, subTitle: cardSubTitleInput.value, level: cardLevelInput.value, attributes });
                } else {
                    cardData = { id: Date.now().toString(), title: cardTitleInput.value, subTitle: cardSubTitleInput.value, level: cardLevelInput.value, attributes };
                }
                if (characterImageFile) { cardData.image = await readFileAsArrayBuffer(characterImageFile); cardData.imageMimeType = characterImageFile.type; }
                if (backgroundImageFile) { cardData.backgroundImage = await readFileAsArrayBuffer(backgroundImageFile); cardData.backgroundMimeType = backgroundImageFile.type; }
                await saveData(CARD_STORE_NAME, cardData);
                
                cardForm.reset();
                characterImageFile = null; backgroundImageFile = null;
                showImagePreview(characterImagePreview, null, true);
                showImagePreview(backgroundImagePreview, null, false);
                currentEditingCardId = null;
                
                await renderCardsAndThumbnails();
                showDisplayView();
            });

            spellForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                let spellData;

                if (currentEditingSpellId) {
                    const allSpells = await getData(SPELL_STORE_NAME);
                    spellData = allSpells.find(s => s.id === currentEditingSpellId);
                    if (!spellData) return;
                    Object.assign(spellData, {
                        name: document.getElementById('spellName').value,
                        execution: document.getElementById('spellExecution').value,
                        range: document.getElementById('spellRange').value,
                        target: document.getElementById('spellTarget').value,
                        duration: document.getElementById('spellDuration').value,
                        description: document.getElementById('spellDescription').value,
                        enhance: document.getElementById('spellEnhance').value,
                        true: document.getElementById('spellTrue').value,
                    });
                } else {
                    spellData = {
                        id: Date.now().toString(),
                        name: document.getElementById('spellName').value,
                        execution: document.getElementById('spellExecution').value,
                        range: document.getElementById('spellRange').value,
                        target: document.getElementById('spellTarget').value,
                        duration: document.getElementById('spellDuration').value,
                        description: document.getElementById('spellDescription').value,
                        enhance: document.getElementById('spellEnhance').value,
                        true: document.getElementById('spellTrue').value,
                    };
                }

                if (spellImageFile) {
                    spellData.image = await readFileAsArrayBuffer(spellImageFile);
                    spellData.imageMimeType = spellImageFile.type;
                }

                await saveData(SPELL_STORE_NAME, spellData);
                
                spellForm.reset();
                spellImageFile = null;
                currentEditingSpellId = null;
                showImagePreview(spellImagePreview, null, true);
                await renderSpellCards();
                showSpellDisplayView();
            });

            itemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                let itemData;
                const itemValues = {
                    name: document.getElementById('itemName').value,
                    type: document.getElementById('itemType').value,
                    damage: document.getElementById('itemDamage').value,
                    charge: document.getElementById('itemCharge').value,
                    prerequisite: document.getElementById('itemPrerequisite').value,
                    effect: document.getElementById('itemEffect').value,
                };

                if (currentEditingItemId) {
                    const allItems = await getData(ITEM_STORE_NAME);
                    itemData = allItems.find(i => i.id === currentEditingItemId);
                    if (!itemData) return;
                    Object.assign(itemData, itemValues);
                } else {
                    itemData = { id: Date.now().toString(), ...itemValues };
                }

                if (itemImageFile) {
                    itemData.image = await readFileAsArrayBuffer(itemImageFile);
                    itemData.imageMimeType = itemImageFile.type;
                }

                await saveData(ITEM_STORE_NAME, itemData);
                
                itemForm.reset();
                itemImageFile = null;
                currentEditingItemId = null;
                showImagePreview(itemImagePreview, null, true);
                await renderItemsAndThumbnails();
                showItemDisplayView();
            });


            // --- ATUALIZADO: L√≥gica de Exibi√ß√£o de Magias em Tela Cheia ---

            async function createExpandedCardView(data, type) {
                let imageURL, palette;
                if (type === 'spell') {
                    imageURL = 'https://placehold.co/400x650/14b8a6/1f2937?text=Magia';
                    if (data.image) imageURL = URL.createObjectURL(bufferToBlob(data.image, data.imageMimeType));
                    palette = { cardBg: 'rgba(17, 24, 39, 0.9)', highlightColor: '#2dd4bf', textColor: '#e5e7eb', borderColor: '#0d9488' };
                } else { // item
                    imageURL = 'https://placehold.co/400x650/f59e0b/422006?text=Item';
                    if (data.image) imageURL = URL.createObjectURL(bufferToBlob(data.image, data.imageMimeType));
                    palette = { cardBg: 'rgba(17, 24, 39, 0.9)', highlightColor: '#f59e0b', textColor: '#e5e7eb', borderColor: '#d97706' };
                }

                if (imageURL && !imageURL.includes('placehold.co')) {
                    try {
                        const newPalette = await getPredominantColorAndPalette(imageURL);
                        palette.borderColor = newPalette.borderColor;
                        palette.highlightColor = newPalette.highlightColor;
                    } catch (e) { console.error(`Falha ao gerar paleta para ${type}.`, e); }
                }

                const cardElement = document.createElement('div');
                cardElement.className = 'rounded-3xl border-2 w-full h-full';
                cardElement.style.borderColor = palette.borderColor;
                cardElement.style.background = `url(${imageURL})`;
                cardElement.style.backgroundSize = 'cover';
                cardElement.style.backgroundPosition = 'center';

                let detailsHtml, mainContentHtml;

                if (type === 'spell') {
                    detailsHtml = `
                        <p class="text-left"><strong>Execu√ß√£o:</strong> ${data.execution || '-'}</p>
                        <p class="text-left"><strong>Alcance:</strong> ${data.range || '-'}</p>
                        <p class="text-left"><strong>Alvo:</strong> ${data.target || '-'}</p>
                        <p class="text-left"><strong>Dura√ß√£o:</strong> ${data.duration || '-'}</p>
                    `;
                    mainContentHtml = `
                        <div class="mb-4 p-3 rounded-3xl w-full" style="scroll-snap-align: start;flex-shrink: 0;min-width: 100%;">
                            <h4 class="font-semibold text-gray-300">Descri√ß√£o</h4>
                            <p class="text-gray-300 text-xs">${data.description || 'Nenhuma descri√ß√£o.'}</p>
                        </div>
                        <div class="mb-4 p-3 rounded-3xl w-full" style="scroll-snap-align: start;flex-shrink: 0;min-width: 100%;">
                            <h4 class="font-semibold text-gray-300">Aprimorar</h4>
                            <p class="text-gray-300 text-xs">${data.enhance || 'Nenhum aprimoramento.'}</p>
                        </div>
                        <div class="p-3 rounded-3xl w-full" style="scroll-snap-align: start;flex-shrink: 0;min-width: 100%;">
                            <h4 class="font-semibold text-gray-300">Verdadeiro</h4>
                            <p class="text-gray-300 text-xs">${data.true || 'Nenhum efeito verdadeiro.'}</p>
                        </div>
                    `;
                } else { // item
                    detailsHtml = `
                        <p class="text-left"><strong>Tipo:</strong> ${data.type || '-'}</p>
                        <p class="text-left"><strong>Dano:</strong> ${data.damage || '-'}</p>
                        <p class="text-left"><strong>Carga:</strong> ${data.charge || '-'}</p>
                        <p class="text-left"><strong>Pr√©-requisito:</strong> ${data.prerequisite || '-'}</p>
                    `;
                    mainContentHtml = `
                        <div class="p-3 rounded-3xl w-full">
                            <h4 class="font-semibold text-gray-300">Efeito</h4>
                            <p class="text-gray-300 text-xs">${data.effect || 'Nenhum efeito.'}</p>
                        </div>
                    `;
                }
                
                cardElement.innerHTML = `
                    <div class="rounded-3xl relative w-full h-full p-4" style="background: linear-gradient(-180deg, #000000ba, transparent, #00000085, #000000ba); height: 650px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; background-blend-mode: multiply;">        
                        <div class="text-center w-full"><h3 class="text-2xl font-bold" style="color: ${palette.highlightColor};">${data.name}</h3><div class="rpg-card-title-divider" style="background: linear-gradient(to right, transparent, ${palette.borderColor}, transparent); width: 100%"></div></div>
                        <div class="text-xs text-gray-400 mb-3" style="position: absolute; margin-top: 55px; left: 15px;">
                            ${detailsHtml}
                        </div>
                       <div class="w-full">                                       
                            <div class="text-sm text-left" style="display: flex; flex-direction: row; overflow-y: scroll;gap: 12px; scroll-snap-type: x mandatory;">                                             
                               ${mainContentHtml}                                           
                            </div>
                        </div>
                    </div>`;
                
                
                return cardElement;
            }

            async function displayTabsInFullscreen(fullscreenElement) {
                const allSpells = await getData(SPELL_STORE_NAME);
                const allItems = await getData(ITEM_STORE_NAME);

                const tabContainer = document.createElement('div');
                tabContainer.className = 'fullscreen-tab-container collapsed';

                const createTabContent = (items, type) => {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'fullscreen-tab-content hidden';
                    contentDiv.dataset.tab = type;
                    items.forEach(item => {
                        let imageURL = type === 'spell' ? 'https://placehold.co/60x60/14b8a6/1f2937?text=M' : 'https://placehold.co/60x60/f59e0b/422006?text=I';
                        if (item.image) {
                            imageURL = URL.createObjectURL(bufferToBlob(item.image, item.imageMimeType));
                        }
                        const itemEl = document.createElement('div');
                        itemEl.className = 'tab-list-item';
                        itemEl.dataset.id = item.id;
                        itemEl.dataset.type = type;
                        itemEl.innerHTML = `<img src="${imageURL}" alt="${item.name}"><p>${item.name}</p>`;
                        contentDiv.appendChild(itemEl);
                    });
                    return contentDiv;
                };

                const spellContent = createTabContent(allSpells, 'spell');
                const itemContent = createTabContent(allItems, 'item');
                
                const toggler = document.createElement('div');
                toggler.className = 'tab-list-toggler';
                toggler.innerHTML = `
                    <div class="flex gap-2">
                        <button data-tab="spell" class="px-3 py-1 rounded-lg bg-indigo-600 text-white" style="display: block; border-radius: 0.5rem .5rem 0 0;">Grim√≥rio</button>
                        <button data-tab="item" class="px-3 py-1 rounded-lg bg-gray-600 text-white" style="display: block; border-radius: 0.5rem .5rem 0 0;">Invent√°rio</button>
                    </div>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                `;
                
                toggler.querySelector('svg').addEventListener('click', (e) => {
                    e.stopPropagation();
                    tabContainer.classList.toggle('collapsed');
                });

                tabContainer.appendChild(toggler);
                tabContainer.appendChild(spellContent);
                tabContainer.appendChild(itemContent);
                fullscreenElement.appendChild(tabContainer);

                toggler.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tab = e.target.dataset.tab;
                        tabContainer.querySelectorAll('.fullscreen-tab-content').forEach(content => content.classList.add('hidden'));
                        tabContainer.querySelector(`.fullscreen-tab-content[data-tab="${tab}"]`).classList.remove('hidden');
                        
                        toggler.querySelectorAll('button').forEach(btn => btn.classList.replace('bg-indigo-600', 'bg-gray-600'));
                        e.target.classList.replace('bg-gray-600', 'bg-indigo-600');
                        
                        if (tabContainer.classList.contains('collapsed')) {
                            tabContainer.classList.remove('collapsed');
                        }
                    });
                });
                
                // Show spells by default
                toggler.querySelector('button[data-tab="spell"]').click();


                [spellContent, itemContent].forEach(content => {
                    content.addEventListener('click', async (e) => {
                        const itemEl = e.target.closest('.tab-list-item');
                        if (!itemEl) return;

                        const id = itemEl.dataset.id;
                        const type = itemEl.dataset.type;
                        
                        const data = await getData(type === 'spell' ? SPELL_STORE_NAME : ITEM_STORE_NAME);
                        const itemData = data.find(d => d.id === id);
                        if (!itemData) return;
                        
                        const existingCard = fullscreenElement.querySelector('.expanded-card-container');
                        if (existingCard) existingCard.remove();

                        const expandedContainer = document.createElement('div');
                        expandedContainer.className = 'expanded-card-container';
                        
                        const cardHolder = document.createElement('div');
                        cardHolder.className = 'expanded-card';
                        
                        const cardContent = await createExpandedCardView(itemData, type);
                        cardHolder.appendChild(cardContent);
                        expandedContainer.appendChild(cardHolder);
                        fullscreenElement.appendChild(expandedContainer);

                        setTimeout(() => expandedContainer.classList.add('visible'), 2);

                        expandedContainer.addEventListener('click', function(event) {
                            if (event.target === expandedContainer) {
                                expandedContainer.classList.remove('visible');
                                expandedContainer.addEventListener('transitionend', () => expandedContainer.remove(), { once: true });
                            }
                        });
                    });
                });
            }

            cardDisplayArea.addEventListener('click', async (e) => {
                const cardId = e.target.dataset.cardId;
                if (!cardId) return;

                if (e.target.classList.contains('edit-btn')) {
                    await editCard(cardId);
                } else if (e.target.classList.contains('remove-btn')) {
                    await removeCard(cardId);
                } else if (e.target.classList.contains('fullscreen-btn')) {
                    const cardDiv = e.target.closest('.card-wrapper').querySelector('.rpg-card');
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        cardDiv.requestFullscreen().catch(err => console.error(`Erro ao entrar em tela cheia: ${err.message}`));
                        
                        displayTabsInFullscreen(cardDiv);
                        
                        const onFullscreenChange = () => {
                            if (!document.fullscreenElement) {
                                const tabContainer = cardDiv.querySelector('.fullscreen-tab-container');
                                if (tabContainer) tabContainer.remove();
                                const expandedCard = cardDiv.querySelector('.expanded-card-container');
                                if (expandedCard) expandedCard.remove();
                                document.removeEventListener('fullscreenchange', onFullscreenChange);
                            }
                        };
                        document.addEventListener('fullscreenchange', onFullscreenChange);
                    }
                }
            });

            async function generateCharacterSheetText() {
                const allCards = await getData(CARD_STORE_NAME);
                const allSpells = await getData(SPELL_STORE_NAME);
                const allItems = await getData(ITEM_STORE_NAME);

                let text = "FICHA DE PERSONAGENS, MAGIAS E ITENS\n";
                text += "========================================\n\n";

                if (allCards.length > 0) {
                    text += "PERSONAGENS\n";
                    text += "----------------------------------------\n";
                    allCards.forEach(card => {
                        text += `Nome: ${card.title || ''}\n`;
                        text += `Ra√ßa e Classe: ${card.subTitle || ''}\n`;
                        text += `N√≠vel: ${card.level || ''}\n\n`;
                        text += "Atributos:\n";
                        if (card.attributes) {
                            for (const [key, value] of Object.entries(card.attributes)) {
                                if (key !== 'pericias') {
                                    text += `  - ${key.charAt(0).toUpperCase() + key.slice(1)}: ${value || ''}\n`;
                                }
                            }
                            text += "\nPer√≠cias:\n";
                            text += `  - ${(card.attributes.pericias || []).join(', ')}\n`;
                        }
                        text += "----------------------------------------\n";
                    });
                }

                if (allSpells.length > 0) {
                    text += "\n\nGRIM√ìRIO\n";
                    text += "----------------------------------------\n";
                    allSpells.forEach(spell => {
                        text += `Magia: ${spell.name || ''}\n`;
                        text += `  - Execu√ß√£o: ${spell.execution || ''}\n`;
                        text += `  - Alcance: ${spell.range || ''}\n`;
                        text += `  - Alvo: ${spell.target || ''}\n`;
                        text += `  - Dura√ß√£o: ${spell.duration || ''}\n`;
                        text += `  - Descri√ß√£o: ${spell.description || ''}\n`;
                        text += `  - Aprimorar: ${spell.enhance || ''}\n`;
                        text += `  - Verdadeiro: ${spell.true || ''}\n`;
                        text += "----------------------------------------\n";
                    });
                }

                if (allItems.length > 0) {
                    text += "\n\nINVENT√ÅRIO\n";
                    text += "----------------------------------------\n";
                    allItems.forEach(item => {
                        text += `Item: ${item.name || ''}\n`;
                        text += `  - Tipo: ${item.type || ''}\n`;
                        text += `  - Dano: ${item.damage || ''}\n`;
                        text += `  - Carga: ${item.charge || ''}\n`;
                        text += `  - Pr√©-requisito: ${item.prerequisite || ''}\n`;
                        text += `  - Efeito: ${item.effect || ''}\n`;
                        text += "----------------------------------------\n";
                    });
                }

                return text;
            }

            saveDbBtn.addEventListener('click', async () => {
                const textContent = await generateCharacterSheetText();
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ficha_rpg.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            cleanupBtn.addEventListener('click', async () => {
                await deleteOldDatabases();
                const originalText = cleanupBtn.innerHTML;
                cleanupBtn.innerHTML = '<span>Limpo!</span>';
                setTimeout(() => {
                    cleanupBtn.innerHTML = originalText;
                }, 2000);
            });


            // Inicializa√ß√£o
            async function initializeApp() {
                showSplash();
                try {
                    await openDatabase();
                    await deleteOldDatabases();
                    populatePericiasCheckboxes();
                    await renderCardsAndThumbnails();
                    await renderSpellCards();
                    await renderItemsAndThumbnails();
                    showDisplayView();
                    setTimeout(hideSplash, 1000);
                } catch (e) {
                    console.error("Falha ao inicializar o app:", e);
                    hideSplash();
                }
            }

            initializeApp();
        });
    </script>
</body>
</html>

